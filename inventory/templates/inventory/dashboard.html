{% extends "inventory/base.html" %}

{% block content %}
<h2 class="mb-4">ðŸ“Š Tableau de bord</h2>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card text-bg-primary shadow">
      <div class="card-body">
        <h5 class="card-title">PiÃ¨ces totales</h5>
        <p class="display-6">{{ total_pieces }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-danger shadow">
      <div class="card-body">
        <h5 class="card-title">En alerte</h5>
        <p class="display-6">{{ alertes }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Liste des piÃ¨ces en alerte -->
{% if alertes_qs %}
<h4>ðŸš¨ PiÃ¨ces Ã  ravitailler :</h4>
<ul class="list-group mb-4">
  {% for p in alertes_qs %}
    <li class="list-group-item">
      {{ p.nom_piece }} ({{ p.marque.nom }}) â€” 
      Restant : {{ p.stock_reel }} / Seuil : {{ p.stock_securite }}
    </li>
  {% endfor %}
</ul>
{% endif %}

<!-- DerniÃ¨res transactions -->
<h3 class="mb-3">ðŸ“¦ DerniÃ¨res transactions</h3>
<ul class="list-group mb-4">
  {% for t in last_transactions %}
    <li class="list-group-item">
      {{ t.date|date:"d/m/Y H:i" }} â€” 
      <strong>{{ t.piece.nom_piece }}</strong> â€”
      {% if t.type == "ENTREE" %}
        <span class="text-success">+{{ t.quantite }} (EntrÃ©e)</span>
      {% else %}
        <span class="text-danger">-{{ t.quantite }} (Sortie)</span>
      {% endif %}
    </li>
  {% empty %}
    <li class="list-group-item">Aucune transaction</li>
  {% endfor %}
</ul>

<!-- Graphiques -->
<div class="row">
  <div class="col-md-6">
    <canvas id="pieChart" height="200"></canvas>
  </div>
  <div class="col-md-6">
    <canvas id="barChart" height="200"></canvas>
  </div>
</div>

<div class="row mt-4">
  <div class="col-12">
    <canvas id="lineChart" height="100"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Camembert : rÃ©partition stock par marque
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: {{ chart_pie_labels|safe }},
      datasets: [{
        data: {{ chart_pie_data|safe }},
        backgroundColor: ["#0d6efd","#dc3545","#198754","#ffc107","#6f42c1"]
      }]
    }
  });

  // Bar chart : top 5 piÃ¨ces
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: {{ chart_bar_labels|safe }},
      datasets: [{
        label: "Stock restant",
        data: {{ chart_bar_data|safe }},
        backgroundColor: "#198754"
      }]
    },
    options: { indexAxis: "y" }
  });

  // Line chart : flux transactions
  new Chart(document.getElementById("lineChart"), {
    type: "line",
    data: {
      labels: {{ flux_dates|safe }},
      datasets: [
        { label: "EntrÃ©es", data: {{ flux_entrees|safe }}, borderColor: "#198754", backgroundColor: "rgba(25,135,84,0.2)" },
        { label: "Sorties", data: {{ flux_sorties|safe }}, borderColor: "#dc3545", backgroundColor: "rgba(220,53,69,0.2)" }
      ]
    }
  });
});
</script>
{% endblock %}
